<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.furnature.mapper.AdminMapper">
	<select id="selectUserList" parameterType="hashmap" resultType="com.example.furnature.model.Admin">
		SELECT 
		    USER_ID, USER_NAME, USER_ADDR, USER_PHONE, USER_EMAIL,
		    TO_CHAR(USER_BIRTH, 'YYYY-MM-DD') USER_BIRTH,
		    CASE WHEN USER_AUTH = '2' THEN '관리자'
		         ELSE '일반회원'
		    END USER_AUTH,
		    CASE WHEN EVENT_ROUL = 'Y' THEN '참여가능'
		         ELSE '참여완료'
		    END EVENT_ROUL            
		FROM TBL_USER
		WHERE 1=1 
		<if test="keyword != null and keyword != ''">
			AND USER_NAME LIKE '%' || #{keyword} || '%'
		</if>
		ORDER BY USER_AUTH ASC, USER_NAME
		OFFSET #{currentPage} ROWS FETCH FIRST #{pageSize} ROWS ONLY
	</select>
	
	<select id="selectAllUser" parameterType="hashmap" resultType="com.example.furnature.model.Admin">
		SELECT COUNT(*) ALL_USER
		FROM TBL_USER
		WHERE 1=1 
		<if test="keyword != null and keyword != ''">
			AND USER_NAME LIKE '%' || #{keyword} || '%'
		</if>
	</select>
	
	<select id="selectUser" parameterType="hashmap" resultType="com.example.furnature.model.Admin">
		SELECT *
		FROM TBL_USER
		WHERE USER_ID = #{id}
	</select>
	
	<delete id="deleteUser" parameterType="hashmap">
		DELETE FROM TBL_USER
		WHERE USER_ID = #{id}
	</delete>
	
	<update id="updateUser" parameterType="hashmap">
		UPDATE TBL_USER
		<set>
			<if test="phone != null and phone != ''">USER_PHONE = #{phone},</if>
			<if test="email != null and email != ''">USER_EMAIL = #{email},</if>
			<if test="email != null and email != ''">EVENT_ROUL = #{roul},</if>
		</set>
		WHERE USER_ID = #{id}
	</update>
  
  <update id="resetPwd" parameterType="hashmap">
		UPDATE TBL_USER
		SET USER_PWD = '1234'
		WHERE USER_ID = #{id}
	</update>	

	<!--원데이클래스 신청인수 등 현황-->
	<select id="currentNumber" parameterType="hashmap" resultType="com.example.furnature.model.Admin">
	    SELECT C.CLASS_NO, CLASS_NAME, CLASS_DATE, END_DAY, NUMBER_LIMIT, NVL(COUNT, 0) AS CURRENT_NUMBER
	    FROM TBL_CLASS C
	    LEFT JOIN (
	        SELECT NVL(COUNT(*),0) COUNT, CLASS_NO
	        FROM TBL_PARTICIPANT
	        GROUP BY CLASS_NO
	    ) P ON C.CLASS_NO = P.CLASS_NO
	    WHERE 1 = 1
	    <if test="searchOption == 'all' and (keyword != null and keyword != '')">
	        AND (CLASS_NAME LIKE '%' || #{keyword} || '%' OR END_DAY LIKE '%' || #{keyword} || '%')
	    </if>
	    <if test="searchOption == 'className' and (keyword != null and keyword != '')">
	        AND CLASS_NAME LIKE '%' || #{keyword} || '%'
	    </if>
	    <if test="searchOption == 'endDay' and (keyword != null and keyword != '')">
	        AND END_DAY LIKE '%' || #{keyword} || '%'
	    </if>
	    ORDER BY C.CLASS_NO
	</select>

	<!--원데이클래스 삭제-->
	<delete id="onedayDelete" parameterType="hashmap">
		DELETE FROM TBL_CLASS
		WHERE CLASS_NO = #{classNo}
	</delete>
	
	<!--원데이클래스 파일삭제-->
	<delete id="onedayFileDelete" parameterType="hashmap">
		DELETE FROM TBL_ONEDAYFILE
		WHERE CLASS_NO = #{classNo}
	</delete>
	
	<!--원데이클래스 개별정보 출력-->
	<select id="onedayInfo" parameterType="hashmap" resultType="com.example.furnature.model.Admin">
	    SELECT * 
	    FROM TBL_CLASS
	    WHERE CLASS_NO = #{classNo}
	</select>

</mapper>
