<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.furnature.mapper.OnedayMapper">
	<!--원데이클래스 목록 출력-->
	<select id="onedayList" parameterType="hashmap" resultType="com.example.furnature.model.Oneday">
		SELECT C.*, O.* FROM TBL_CLASS C
		INNER JOIN TBL_ONEDAYFILE O
		ON C.CLASS_NO = O.CLASS_NO
		WHERE O.FILE_NO = (
	    SELECT MIN(FILE_NO) 
	    FROM TBL_ONEDAYFILE 
	    WHERE CLASS_NO = C.CLASS_NO)
	</select>
	
	<!--원데이클래스 개별 상세정보 출력-->
	<select id="onedayDetail" parameterType="hashmap" resultType="com.example.furnature.model.Oneday">
		SELECT * FROM TBL_CLASS C
		INNER JOIN TBL_ONEDAYFILE O
		ON C.CLASS_NO = O.CLASS_NO
		WHERE C.CLASS_NO = #{classNo}
	</select>

	<!--원데이클래스 결제정보-->
	<insert id="onedayPay" parameterType="hashmap">
		INSERT INTO TBL_PARTICIPANT (PAY_ID, USER_NAME, USER_ID, COUNT, PRICE, PAY_DAY, CLASS_NO) VALUES (#{payId}, #{name}, 'user1', 1, #{price}, SYSDATE, #{classNo})
	</insert>
	
	<!--원데이클래스 등록(관리자)-->
	<insert id="onedayReg" parameterType="hashmap">
		INSERT INTO TBL_CLASS (CLASS_NO, CLASS_NAME, PRICE, NUMBER_LIMIT, CLASS_DATE, START_DAY, END_DAY)
		VALUES (#{classNo}, #{className}, #{price}, #{numberLimit}, #{classDate}, #{startDay}, #{endDay})
	</insert>
	
	<!--원데이클래스 등록시 파일업로드-->
	<insert id="onedayFile" parameterType="hashmap">
		INSERT INTO TBL_ONEDAYFILE (FILE_NAME, FILE_PATH, FILE_SIZE, EXT_NAME, CLASS_NO, FILE_NO)
		VALUES (#{fileName}, #{filePath}, #{fileSize}, #{extName}, #{classNo}, FILE_NO_SEQ.NEXTVAL)
	</insert>
	
	<!--원데이클래스 등록시 클래스번호 시퀀스로 가져오기-->
	<select id="classNo" parameterType="hashmap" resultType="int">
		SELECT MAX(CLASS_NO) +1 FROM TBL_CLASS
	</select>
	
	<!--원데이클래스 인원초과 여부 확인-->
	<select id="numberLimit" parameterType="hashmap" resultType="Integer">
		SELECT 
		    CASE 
		        WHEN COUNT(P.CLASS_NO) = C.NUMBER_LIMIT THEN 1 
		        ELSE 0 
		    END AS result
		FROM TBL_PARTICIPANT P
		INNER JOIN TBL_CLASS C ON P.CLASS_NO = C.CLASS_NO
		WHERE P.CLASS_NO = #{classNo}
		GROUP BY C.CLASS_NO, C.NUMBER_LIMIT
	</select>

	<!--원데이클래스 수정(관리자)-->
	<update id="onedayUpdate" parameterType="hashmap">
		UPDATE TBL_CLASS 
			SET 
			    CLASS_NO = #{classNo}, 
			    CLASS_NAME = #{className}, 
			    PRICE = #{price}, 
			    NUMBER_LIMIT = #{numberLimit}, 
			    CLASS_DATE = TO_DATE(#{classDate}, 'YYYY-MM-DD HH24:MI:SS'),
			    START_DAY = TO_DATE(#{startDay}, 'YYYY-MM-DD HH24:MI:SS'), 
			    END_DAY = TO_DATE(#{endDay}, 'YYYY-MM-DD HH24:MI:SS')
			WHERE 
			    CLASS_NO = #{classNo}  
	</update>
	
</mapper>	