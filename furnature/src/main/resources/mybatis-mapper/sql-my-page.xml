<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.furnature.mapper.MyPageMapper">
	<select id="selectUser" parameterType="hashmap" resultType="com.example.furnature.model.MyPage">
		SELECT *
		FROM TBL_USER U
		<if test="sessionId != 'admin'">
		INNER JOIN (
		    SELECT USER_ID,
			    SUM(CASE WHEN MILEAGE_STATUS = '적립' THEN MILEAGE_PRICE
			        WHEN MILEAGE_STATUS = '사용' THEN -MILEAGE_PRICE END) MILEAGE_PRICE
			FROM TBL_MILEAGE
			GROUP BY USER_ID
		) M ON U.USER_ID = M.USER_ID
		</if>
		WHERE U.USER_ID = #{sessionId}
	</select>
	
	<select id="onedayInfo" parameterType="hashmap" resultType="com.example.furnature.model.MyPage">
		SELECT *
		FROM TBL_PARTICIPANT P
		INNER JOIN TBL_CLASS C
		ON P.CLASS_NO = C.CLASS_NO
		WHERE P.USER_ID = #{sessionId}
	</select>
	
	<delete id="onedayCancel" parameterType="hashmap">
		DELETE FROM TBL_PARTICIPANT
		WHERE CLASS_NO = #{classNo} AND USER_ID = #{sessionId}
	</delete>
	
	<select id="selectBiddingList" parameterType="hashmap" resultType="com.example.furnature.model.MyPage">
		SELECT MY_BIDDING, B.AUCTION_NO, B.AUCTION_BIDDING_DATE, AUCTION_TITLE, A.AUCTION_PRICE_CURRENT, A.AUCTION_STATUS
		FROM TBL_AUCTION_BIDDING B
		INNER JOIN (
		            SELECT MAX(AUCTION_BIDDING_PRICE) as MY_BIDDING, AUCTION_NO, USER_ID
		            FROM TBL_AUCTION_BIDDING
		            GROUP BY AUCTION_NO, USER_ID
		) M ON B.AUCTION_BIDDING_PRICE = M.MY_BIDDING
		INNER JOIN TBL_AUCTION A ON B.AUCTION_NO = A.AUCTION_NO
		WHERE B.USER_ID = #{sessionId}
	</select>
	
	<delete id="deleteBidding" parameterType="hashmap">
		DELETE FROM TBL_AUCTION_BIDDING
		WHERE AUCTION_NO = #{auctionNo} AND USER_ID = #{sessionId}
	</delete>
	
	<select id="selectMaxPrice" parameterType="hashmap" resultType="com.example.furnature.model.MyPage">
		SELECT MAX(AUCTION_BIDDING_PRICE) AUCTION_BIDDING_PRICE
		FROM TBL_AUCTION_BIDDING
		WHERE AUCTION_NO = #{auctionNo}
	</select>
	
	<update id="updateAuctionPrice" parameterType="hashmap">
		UPDATE TBL_AUCTION
		SET AUCTION_PRICE_CURRENT = #{biddingPrice}
		WHERE AUCTION_NO = #{auctionNo}
	</update>
	
	<select id="selectPrice" parameterType="hashmap" resultType="com.example.furnature.model.MyPage">
		SELECT *
		FROM TBL_AUCTION
		WHERE AUCTION_NO = #{auctionNo}
	</select>
</mapper>
